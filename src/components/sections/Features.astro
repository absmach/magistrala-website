---
import { FEATURES } from '../../config/site';
import { FEATURES_CONTENT } from '../../config/home';
import ScreenshotFrame from '../ui/ScreenshotFrame.astro';
import FeatureIcon from '../ui/FeatureIcon.astro';
---

<!-- Features header -->
<section id="features" class="section-padding bg-white pb-0">
  <div class="max-w-2xl mx-auto text-center reveal">
    <h2 class="mb-4">{FEATURES_CONTENT.heading}</h2>
    <p class="text-neutral-600">
      {FEATURES_CONTENT.description}
    </p>
  </div>
</section>

<!-- Feature bands -->
{FEATURES.map((feature, i) => (
  <div class:list={['feature-band', i % 2 === 1 ? 'feature-band-tinted' : '']}>
    <div class="max-w-7xl mx-auto">
      <div class:list={['grid lg:grid-cols-2 gap-12 items-center reveal']}>
        <div class:list={[i % 2 === 1 ? 'lg:order-2' : '']}>
          <FeatureIcon icon={feature.icon} class="mb-4" />
          <h3 class="text-2xl font-semibold mb-3 text-[#04203a]">{feature.title}</h3>
          <p class="text-neutral-600 leading-relaxed">{feature.description}</p>
        </div>

        <div class:list={[i % 2 === 1 ? 'lg:order-1' : '']}>
          {feature.visual.type === 'screenshots' && (
            <div class="feature-carousel" data-feature-carousel data-auto="4000">
              <div class="feature-carousel-track">
                {feature.visual.images.map((img) => (
                  <div class="feature-carousel-slide">
                    {/* Browser frame */}
                    {(feature.visual as any).frame === 'browser' && (
                      <ScreenshotFrame src={img.src} alt={img.alt} />
                    )}
                    {/* Dashboard frame */}
                    {(feature.visual as any).frame === 'dashboard' && (
                      <div class="dashboard-frame">
                        <div class="dashboard-frame-sidebar">
                          <div class="dashboard-frame-sidebar-dot"></div>
                          <div class="dashboard-frame-sidebar-dot"></div>
                          <div class="dashboard-frame-sidebar-dot active"></div>
                          <div class="dashboard-frame-sidebar-dot"></div>
                          <div class="dashboard-frame-sidebar-dot"></div>
                        </div>
                        <div class="dashboard-frame-content">
                          <img src={img.src} alt={img.alt} loading="lazy" />
                        </div>
                      </div>
                    )}
                    {/* Floating frame */}
                    {(feature.visual as any).frame === 'floating' && (
                      <div class="floating-frame">
                        <img src={img.src} alt={img.alt} loading="lazy" />
                      </div>
                    )}
                  </div>
                ))}
              </div>
              {feature.visual.images.length > 1 && (
                <div>
                  <div class="flex justify-center gap-2 mt-4">
                    {feature.visual.images.map((_, j) => (
                      <button
                        class:list={['carousel-dot', j === 0 ? 'active' : '']}
                        data-slide={j}
                        aria-label={`Go to slide ${j + 1}`}
                      />
                    ))}
                  </div>
                  <div class="carousel-progress">
                    <div class="carousel-progress-bar"></div>
                  </div>
                </div>
              )}
            </div>
          )}

          {feature.visual.type === 'protocols' && (
            <div class="bg-[#f8fafc] rounded-xl border border-neutral-200 p-8">
              <svg viewBox="0 0 400 280" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-auto">
                <!-- Central hub -->
                <circle cx="200" cy="140" r="40" fill="#073763" opacity="0.1" />
                <circle cx="200" cy="140" r="28" fill="#073763" opacity="0.15" style="animation: pulseRing 3s ease-in-out infinite;" />
                <circle cx="200" cy="140" r="18" fill="#073763" />
                <text x="200" y="145" text-anchor="middle" fill="white" font-size="10" font-weight="600">MG</text>

                <!-- MQTT -->
                <circle cx="60" cy="60" r="24" fill="#eff6ff" stroke="#073763" stroke-width="1.5" />
                <text x="60" y="64" text-anchor="middle" fill="#073763" font-size="9" font-weight="600">MQTT</text>
                <line x1="84" y1="75" x2="175" y2="125" stroke="#073763" stroke-width="1.5" stroke-dasharray="4 4" style="animation: dataFlow 2s linear infinite;" />

                <!-- CoAP -->
                <circle cx="340" cy="60" r="24" fill="#eff6ff" stroke="#073763" stroke-width="1.5" />
                <text x="340" y="64" text-anchor="middle" fill="#073763" font-size="9" font-weight="600">CoAP</text>
                <line x1="316" y1="75" x2="225" y2="125" stroke="#073763" stroke-width="1.5" stroke-dasharray="4 4" style="animation: dataFlow 2s linear infinite; animation-delay: 0.5s;" />

                <!-- HTTP -->
                <circle cx="60" cy="220" r="24" fill="#eff6ff" stroke="#073763" stroke-width="1.5" />
                <text x="60" y="224" text-anchor="middle" fill="#073763" font-size="9" font-weight="600">HTTP</text>
                <line x1="84" y1="205" x2="175" y2="155" stroke="#073763" stroke-width="1.5" stroke-dasharray="4 4" style="animation: dataFlow 2s linear infinite; animation-delay: 1s;" />

                <!-- WebSocket -->
                <circle cx="340" cy="220" r="24" fill="#eff6ff" stroke="#073763" stroke-width="1.5" />
                <text x="340" y="218" text-anchor="middle" fill="#073763" font-size="7" font-weight="600">Web</text>
                <text x="340" y="228" text-anchor="middle" fill="#073763" font-size="7" font-weight="600">Socket</text>
                <line x1="316" y1="205" x2="225" y2="155" stroke="#073763" stroke-width="1.5" stroke-dasharray="4 4" style="animation: dataFlow 2s linear infinite; animation-delay: 1.5s;" />
              </svg>
            </div>
          )}

          {feature.visual.type === 'rbac' && (
            <div class="bg-[#f8fafc] rounded-xl border border-neutral-200 p-8">
              <svg viewBox="0 0 400 260" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-auto">
                <!-- Domain -->
                <g style="animation: fadeInScale 0.6s ease forwards;">
                  <rect x="150" y="10" width="100" height="36" rx="8" fill="#073763" />
                  <text x="200" y="33" text-anchor="middle" fill="white" font-size="11" font-weight="600">Domain</text>
                </g>

                <!-- Connectors from Domain -->
                <line x1="175" y1="46" x2="100" y2="80" stroke="#073763" stroke-width="1.5" opacity="0.4" />
                <line x1="200" y1="46" x2="200" y2="80" stroke="#073763" stroke-width="1.5" opacity="0.4" />
                <line x1="225" y1="46" x2="300" y2="80" stroke="#073763" stroke-width="1.5" opacity="0.4" />

                <!-- Admin -->
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 0.2s;">
                  <rect x="50" y="80" width="100" height="32" rx="6" fill="#eff6ff" stroke="#073763" stroke-width="1.5" />
                  <text x="100" y="100" text-anchor="middle" fill="#073763" font-size="10" font-weight="500">Admin</text>
                </g>

                <!-- Editor -->
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 0.4s;">
                  <rect x="150" y="80" width="100" height="32" rx="6" fill="#eff6ff" stroke="#073763" stroke-width="1.5" />
                  <text x="200" y="100" text-anchor="middle" fill="#073763" font-size="10" font-weight="500">Editor</text>
                </g>

                <!-- Viewer -->
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 0.6s;">
                  <rect x="250" y="80" width="100" height="32" rx="6" fill="#eff6ff" stroke="#073763" stroke-width="1.5" />
                  <text x="300" y="100" text-anchor="middle" fill="#073763" font-size="10" font-weight="500">Viewer</text>
                </g>

                <!-- Connectors down -->
                <line x1="100" y1="112" x2="100" y2="145" stroke="#073763" stroke-width="1" opacity="0.3" />
                <line x1="200" y1="112" x2="200" y2="145" stroke="#073763" stroke-width="1" opacity="0.3" />
                <line x1="300" y1="112" x2="300" y2="145" stroke="#073763" stroke-width="1" opacity="0.3" />

                <!-- Resources row -->
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 0.8s;">
                  <rect x="40" y="145" width="80" height="28" rx="6" fill="#073763" opacity="0.08" stroke="#073763" stroke-width="1" />
                  <text x="80" y="163" text-anchor="middle" fill="#073763" font-size="9">Clients</text>
                </g>
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 0.9s;">
                  <rect x="130" y="145" width="80" height="28" rx="6" fill="#073763" opacity="0.08" stroke="#073763" stroke-width="1" />
                  <text x="170" y="163" text-anchor="middle" fill="#073763" font-size="9">Channels</text>
                </g>
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 1s;">
                  <rect x="220" y="145" width="80" height="28" rx="6" fill="#073763" opacity="0.08" stroke="#073763" stroke-width="1" />
                  <text x="260" y="163" text-anchor="middle" fill="#073763" font-size="9">Groups</text>
                </g>
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 1.1s;">
                  <rect x="310" y="145" width="80" height="28" rx="6" fill="#073763" opacity="0.08" stroke="#073763" stroke-width="1" />
                  <text x="350" y="163" text-anchor="middle" fill="#073763" font-size="9">Dashboards</text>
                </g>

                <!-- Permission badges -->
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 1.3s;">
                  <rect x="55" y="195" width="50" height="20" rx="10" fill="#073763" opacity="0.12" />
                  <text x="80" y="209" text-anchor="middle" fill="#073763" font-size="8" font-weight="500">read</text>
                  <rect x="115" y="195" width="50" height="20" rx="10" fill="#073763" opacity="0.12" />
                  <text x="140" y="209" text-anchor="middle" fill="#073763" font-size="8" font-weight="500">write</text>
                  <rect x="175" y="195" width="50" height="20" rx="10" fill="#073763" opacity="0.12" />
                  <text x="200" y="209" text-anchor="middle" fill="#073763" font-size="8" font-weight="500">delete</text>
                  <rect x="235" y="195" width="52" height="20" rx="10" fill="#073763" opacity="0.12" />
                  <text x="261" y="209" text-anchor="middle" fill="#073763" font-size="8" font-weight="500">assign</text>
                  <rect x="297" y="195" width="56" height="20" rx="10" fill="#073763" opacity="0.12" />
                  <text x="325" y="209" text-anchor="middle" fill="#073763" font-size="8" font-weight="500">manage</text>
                </g>

                <!-- SpiceDB badge -->
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 1.5s;">
                  <rect x="130" y="232" width="140" height="24" rx="12" fill="#073763" opacity="0.06" stroke="#073763" stroke-width="1" stroke-dasharray="3 3" />
                  <text x="200" y="248" text-anchor="middle" fill="#073763" font-size="8" opacity="0.7">Powered by SpiceDB / Zanzibar</text>
                </g>
              </svg>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
))}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-feature-carousel]').forEach((carousel) => {
      const track = carousel.querySelector('.feature-carousel-track') as HTMLElement;
      const dots = carousel.querySelectorAll('.carousel-dot');
      const progressBar = carousel.querySelector('.carousel-progress-bar') as HTMLElement;
      const slideCount = track ? track.children.length : 0;
      if (!track || slideCount <= 1) return;

      let current = 0;
      let autoInterval: ReturnType<typeof setInterval> | null = null;
      let progressStart = 0;
      let progressRaf: number | null = null;
      const delay = parseInt(carousel.getAttribute('data-auto') || '4000');

      function goTo(index: number) {
        current = index;
        track.style.transform = `translateX(-${current * 100}%)`;
        dots.forEach((d) => d.classList.remove('active'));
        dots[current]?.classList.add('active');
        resetProgress();
      }

      function next() {
        goTo((current + 1) % slideCount);
      }

      function resetProgress() {
        progressStart = performance.now();
        if (!progressRaf) tickProgress();
      }

      function tickProgress() {
        if (!progressBar) return;
        const elapsed = performance.now() - progressStart;
        const pct = Math.min((elapsed / delay) * 100, 100);
        progressBar.style.width = `${pct}%`;
        if (pct < 100) {
          progressRaf = requestAnimationFrame(tickProgress);
        } else {
          progressRaf = null;
        }
      }

      function startAuto() {
        stopAuto();
        resetProgress();
        autoInterval = setInterval(next, delay);
      }

      function stopAuto() {
        if (autoInterval) { clearInterval(autoInterval); autoInterval = null; }
        if (progressRaf) { cancelAnimationFrame(progressRaf); progressRaf = null; }
        if (progressBar) progressBar.style.width = '0%';
      }

      dots.forEach((dot) => {
        dot.addEventListener('click', () => {
          goTo(parseInt(dot.getAttribute('data-slide') || '0'));
          startAuto();
        });
      });

      carousel.addEventListener('mouseenter', stopAuto);
      carousel.addEventListener('mouseleave', startAuto);

      startAuto();
    });
  });
</script>
