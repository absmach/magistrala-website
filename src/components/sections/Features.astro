---
import { FEATURES } from '../../config/site';
import { FEATURES_CONTENT } from '../../config/home';
import ScreenshotFrame from '../ui/ScreenshotFrame.astro';
import FeatureIcon from '../ui/FeatureIcon.astro';
import ProtocolTerminal from '../ui/ProtocolTerminal.astro';
---

<!-- Features header -->
<section id="features" class="section-padding bg-white pb-0">
  <div class="max-w-2xl mx-auto text-center reveal">
    <h2 class="mb-4">{FEATURES_CONTENT.heading}</h2>
    <p class="text-neutral-600">
      {FEATURES_CONTENT.description}
    </p>
  </div>
</section>

<!-- Feature bands -->
{FEATURES.map((feature, i) => (
  <div class:list={['feature-band', i % 2 === 1 ? 'feature-band-tinted' : '']}>
    <div class="max-w-7xl mx-auto">
      <div class:list={['grid lg:grid-cols-3 gap-12 items-center reveal']}>
        <div class:list={[i % 2 === 1 ? 'lg:order-2' : '']}>
          <FeatureIcon icon={feature.icon} class="mb-4" />
          <h3 class="text-2xl font-semibold mb-3 text-[#04203a]">{feature.title}</h3>
          <p class="text-neutral-600 leading-relaxed text-xl">{feature.description}</p>
        </div>

        <div class:list={[i % 2 === 1 ? 'lg:order-1' : '', "col-span-2"]}>
          {feature.visual.type === 'screenshots' && (
            <div class="feature-carousel" data-feature-carousel data-auto="4000">
              <div class="feature-carousel-track">
                {feature.visual.images.map((img) => (
                  <div class="feature-carousel-slide">
                    <ScreenshotFrame src={img.src} alt={img.alt} />
                  </div>
                ))}
              </div>
              {feature.visual.images.length > 1 && (
                <div>
                  <div class="flex justify-center gap-2 mt-4">
                    {feature.visual.images.map((_, j) => (
                      <button
                        class:list={['carousel-dot', j === 0 ? 'active' : '']}
                        data-slide={j}
                        aria-label={`Go to slide ${j + 1}`}
                      />
                    ))}
                  </div>
                  <div class="carousel-progress">
                    <div class="carousel-progress-bar"></div>
                  </div>
                </div>
              )}
            </div>
          )}

          {feature.visual.type === 'protocols' && (
            <ProtocolTerminal />
          )}

          {feature.visual.type === 'rbac' && (
            <div class="bg-[#f8fafc] rounded-xl border border-neutral-200 p-8">
              <svg viewBox="0 0 400 260" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-auto">
                <!-- Domain -->
                <g style="animation: fadeInScale 0.6s ease forwards;">
                  <rect x="150" y="10" width="100" height="36" rx="8" fill="#073763" />
                  <text x="200" y="33" text-anchor="middle" fill="white" font-size="11" font-weight="600">Domain</text>
                </g>

                <!-- Connectors from Domain -->
                <line x1="175" y1="46" x2="100" y2="80" stroke="#073763" stroke-width="1.5" opacity="0.4" />
                <line x1="200" y1="46" x2="200" y2="80" stroke="#073763" stroke-width="1.5" opacity="0.4" />
                <line x1="225" y1="46" x2="300" y2="80" stroke="#073763" stroke-width="1.5" opacity="0.4" />

                <!-- Admin -->
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 0.2s;">
                  <rect x="50" y="80" width="100" height="32" rx="6" fill="#eff6ff" stroke="#073763" stroke-width="1.5" />
                  <text x="100" y="100" text-anchor="middle" fill="#073763" font-size="10" font-weight="500">Admin</text>
                </g>

                <!-- Editor -->
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 0.4s;">
                  <rect x="150" y="80" width="100" height="32" rx="6" fill="#eff6ff" stroke="#073763" stroke-width="1.5" />
                  <text x="200" y="100" text-anchor="middle" fill="#073763" font-size="10" font-weight="500">Editor</text>
                </g>

                <!-- Viewer -->
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 0.6s;">
                  <rect x="250" y="80" width="100" height="32" rx="6" fill="#eff6ff" stroke="#073763" stroke-width="1.5" />
                  <text x="300" y="100" text-anchor="middle" fill="#073763" font-size="10" font-weight="500">Viewer</text>
                </g>

                <!-- Connectors down -->
                <line x1="100" y1="112" x2="100" y2="145" stroke="#073763" stroke-width="1" opacity="0.3" />
                <line x1="200" y1="112" x2="200" y2="145" stroke="#073763" stroke-width="1" opacity="0.3" />
                <line x1="300" y1="112" x2="300" y2="145" stroke="#073763" stroke-width="1" opacity="0.3" />

                <!-- Resources row -->
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 0.8s;">
                  <rect x="40" y="145" width="80" height="28" rx="6" fill="#073763" opacity="0.08" stroke="#073763" stroke-width="1" />
                  <text x="80" y="163" text-anchor="middle" fill="#073763" font-size="9">Clients</text>
                </g>
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 0.9s;">
                  <rect x="130" y="145" width="80" height="28" rx="6" fill="#073763" opacity="0.08" stroke="#073763" stroke-width="1" />
                  <text x="170" y="163" text-anchor="middle" fill="#073763" font-size="9">Channels</text>
                </g>
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 1s;">
                  <rect x="220" y="145" width="80" height="28" rx="6" fill="#073763" opacity="0.08" stroke="#073763" stroke-width="1" />
                  <text x="260" y="163" text-anchor="middle" fill="#073763" font-size="9">Groups</text>
                </g>
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 1.1s;">
                  <rect x="310" y="145" width="80" height="28" rx="6" fill="#073763" opacity="0.08" stroke="#073763" stroke-width="1" />
                  <text x="350" y="163" text-anchor="middle" fill="#073763" font-size="9">Dashboards</text>
                </g>

                <!-- Permission badges -->
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 1.3s;">
                  <rect x="55" y="195" width="50" height="20" rx="10" fill="#073763" opacity="0.12" />
                  <text x="80" y="209" text-anchor="middle" fill="#073763" font-size="8" font-weight="500">read</text>
                  <rect x="115" y="195" width="50" height="20" rx="10" fill="#073763" opacity="0.12" />
                  <text x="140" y="209" text-anchor="middle" fill="#073763" font-size="8" font-weight="500">write</text>
                  <rect x="175" y="195" width="50" height="20" rx="10" fill="#073763" opacity="0.12" />
                  <text x="200" y="209" text-anchor="middle" fill="#073763" font-size="8" font-weight="500">delete</text>
                  <rect x="235" y="195" width="52" height="20" rx="10" fill="#073763" opacity="0.12" />
                  <text x="261" y="209" text-anchor="middle" fill="#073763" font-size="8" font-weight="500">assign</text>
                  <rect x="297" y="195" width="56" height="20" rx="10" fill="#073763" opacity="0.12" />
                  <text x="325" y="209" text-anchor="middle" fill="#073763" font-size="8" font-weight="500">manage</text>
                </g>

                <!-- SpiceDB badge -->
                <g style="animation: fadeInScale 0.6s ease forwards; animation-delay: 1.5s;">
                  <rect x="130" y="232" width="140" height="24" rx="12" fill="#073763" opacity="0.06" stroke="#073763" stroke-width="1" stroke-dasharray="3 3" />
                  <text x="200" y="248" text-anchor="middle" fill="#073763" font-size="8" opacity="0.7">Powered by SpiceDB / Zanzibar</text>
                </g>
              </svg>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>
))}

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('[data-feature-carousel]').forEach((carousel) => {
      const track = carousel.querySelector('.feature-carousel-track') as HTMLElement;
      const dots = carousel.querySelectorAll('.carousel-dot');
      const progressBar = carousel.querySelector('.carousel-progress-bar') as HTMLElement;
      const slideCount = track ? track.children.length : 0;
      if (!track || slideCount <= 1) return;

      let current = 0;
      let autoInterval: ReturnType<typeof setInterval> | null = null;
      let progressStart = 0;
      let progressRaf: number | null = null;
      const delay = parseInt(carousel.getAttribute('data-auto') || '4000');

      function goTo(index: number) {
        current = index;
        track.style.transform = `translateX(-${current * 100}%)`;
        dots.forEach((d) => d.classList.remove('active'));
        dots[current]?.classList.add('active');
        resetProgress();
      }

      function next() {
        goTo((current + 1) % slideCount);
      }

      function resetProgress() {
        progressStart = performance.now();
        if (!progressRaf) tickProgress();
      }

      function tickProgress() {
        if (!progressBar) return;
        const elapsed = performance.now() - progressStart;
        const pct = Math.min((elapsed / delay) * 100, 100);
        progressBar.style.width = `${pct}%`;
        if (pct < 100) {
          progressRaf = requestAnimationFrame(tickProgress);
        } else {
          progressRaf = null;
        }
      }

      function startAuto() {
        stopAuto();
        resetProgress();
        autoInterval = setInterval(next, delay);
      }

      function stopAuto() {
        if (autoInterval) { clearInterval(autoInterval); autoInterval = null; }
        if (progressRaf) { cancelAnimationFrame(progressRaf); progressRaf = null; }
        if (progressBar) progressBar.style.width = '0%';
      }

      dots.forEach((dot) => {
        dot.addEventListener('click', () => {
          goTo(parseInt(dot.getAttribute('data-slide') || '0'));
          startAuto();
        });
      });

      carousel.addEventListener('mouseenter', stopAuto);
      carousel.addEventListener('mouseleave', startAuto);

      startAuto();
    });

    // Screenshot hover-to-enlarge using FLIP technique.
    // The overlay is sized at the ENLARGED dimensions so the image renders
    // at full resolution (no CSS scale = no blur). A transform shrinks it
    // to match the original, then animates to identity.
    const SCALE = 1.3;
    const overlay = document.createElement('div');
    overlay.className = 'screenshot-overlay';
    document.body.appendChild(overlay);

    let activeFrame: HTMLElement | null = null;
    let hideRaf: number | null = null;

    function showOverlay(frame: HTMLElement) {
      if (hideRaf) { cancelAnimationFrame(hideRaf); hideRaf = null; }

      const isNewFrame = activeFrame !== frame;
      activeFrame = frame;

      const rect = frame.getBoundingClientRect();

      // Enlarged dimensions
      const enlargedW = rect.width * SCALE;
      const enlargedH = rect.height * SCALE;

      // Centered over the original
      const enlargedLeft = rect.left - (enlargedW - rect.width) / 2;
      const enlargedTop = rect.top - (enlargedH - rect.height) / 2;

      if (isNewFrame) {
        overlay.style.transition = 'none';
        overlay.classList.remove('active');
        overlay.innerHTML = frame.innerHTML;
      }

      // Position at the enlarged size (image renders natively at this size)
      overlay.style.left = `${enlargedLeft}px`;
      overlay.style.top = `${enlargedTop}px`;
      overlay.style.width = `${enlargedW}px`;

      // FLIP: start scaled down to match original, animate to identity
      const inv = 1 / SCALE;
      overlay.style.transformOrigin = 'center center';
      overlay.style.transform = `scale(${inv})`;

      if (isNewFrame) {
        overlay.offsetHeight; // force layout
        overlay.style.transition = '';
      }

      requestAnimationFrame(() => {
        overlay.style.transform = 'scale(1)';
        overlay.classList.add('active');
      });
    }

    function hideOverlay() {
      if (!activeFrame) return;
      const inv = 1 / SCALE;
      overlay.style.transform = `scale(${inv})`;
      overlay.classList.remove('active');
      activeFrame = null;
    }

    document.querySelectorAll('.screenshot-frame').forEach((frame) => {
      frame.addEventListener('mouseenter', () => {
        showOverlay(frame as HTMLElement);
      });
      frame.addEventListener('mouseleave', () => {
        hideRaf = requestAnimationFrame(() => {
          if (!overlay.matches(':hover')) {
            hideOverlay();
          }
        });
      });
    });

    overlay.addEventListener('mouseleave', () => {
      hideOverlay();
    });
  });
</script>
